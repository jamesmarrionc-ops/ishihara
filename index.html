<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cipher Pro v6</title>
    <style>
        body {
            margin: 0;
            background-color: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        /* --- TOP BAR --- */
        #top-bar {
            height: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            font-size: 12px;
            color: #444;
            border-bottom: 1px solid #111;
        }
        #reset-btn { color: #666; padding: 10px; font-size: 20px; }

        /* --- MAIN DISPLAY --- */
        #main-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            overflow: hidden;
        }

        /* The Big Reveal Word */
        #result-word {
            font-size: 2.5rem;
            font-weight: 800;
            margin-top: 5px;
            margin-bottom: 10px;
            color: #eee;
            text-transform: uppercase;
            text-align: center;
            min-height: 50px;
            flex-shrink: 0;
        }

        /* SCROLLABLE CANDIDATES GRID */
        #candidates-wrapper {
            width: 100%;
            flex: 1;
            overflow-y: auto;
            padding-bottom: 10px;
        }
        #candidates-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            width: 100%;
        }

        .candidate-btn {
            background: #111;
            color: #666;
            border: 1px solid #222;
            padding: 12px 5px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
        }
        .candidate-btn:active { background: #fff; color: #000; }

        /* --- FILTER BAR (NEW) --- */
        #filter-bar {
            height: 50px;
            display: flex;
            align-items: center;
            overflow-x: auto;
            background: #050505;
            border-top: 1px solid #222;
            border-bottom: 1px solid #222;
            padding: 0 5px;
            flex-shrink: 0;
            /* Hide scrollbars */
            -ms-overflow-style: none; scrollbar-width: none;
        }
        #filter-bar::-webkit-scrollbar { display: none; }

        .letter-key {
            min-width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 3px;
            border-radius: 5px;
            background: #1a1a1a;
            color: #888;
            font-weight: bold;
            font-size: 14px;
            border: 1px solid #333;
        }
        .letter-key.active {
            background: #007AFF; /* Blue highlight */
            color: white;
            border-color: #007AFF;
        }

        /* --- INPUT ZONES --- */
        .controls {
            height: 30vh; 
            display: flex;
            width: 100%;
            flex-shrink: 0;
            background: #000;
        }
        .zone { flex: 1; }

        /* Helper Text */
        #helper-text {
            font-size: 0.8rem;
            color: #444;
            text-align: center;
            padding: 5px;
            position: absolute;
            bottom: 31vh;
            width: 100%;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="top-bar">
        <div id="status-text">Ready</div>
        <div id="reset-btn" onclick="resetApp()">âœ•</div>
    </div>

    <div id="main-display">
        <div id="result-word"></div>
        <div id="candidates-wrapper">
            <div id="candidates-container"></div>
        </div>
    </div>

    <div id="filter-bar" style="display:none;"> </div>

    <div id="helper-text">Tap to count letters...</div>

    <div class="controls">
        <div class="zone" id="btn-left"></div>
        <div class="zone" id="btn-mid"></div>
        <div class="zone" id="btn-right"></div>
    </div>

    <script>
        const MODEL_NAME = "gemini-1.5-flash"; 
        let apiKey = localStorage.getItem("gemini_api_key");
        if (!apiKey) {
            apiKey = prompt("Paste Gemini API Key:");
            if (apiKey) localStorage.setItem("gemini_api_key", apiKey);
        }

        // STATE
        let mode = "LENGTH"; 
        let wordLength = 0;
        let firstShape = "";
        let lastShape = "";
        let lengthTimer = null;
        
        let allCandidates = []; // Stores the raw list from AI
        let activeFilters = new Set(); // Stores letters currently pressed

        const resultWordEl = document.getElementById("result-word");
        const candidatesContainer = document.getElementById("candidates-container");
        const filterBar = document.getElementById("filter-bar");
        const helperText = document.getElementById("helper-text");
        const statusText = document.getElementById("status-text");

        const buzz = (pattern) => { if (navigator.vibrate) navigator.vibrate(pattern); };

        // INITIALIZE FILTER KEYS
        const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
        alphabet.forEach(letter => {
            const key = document.createElement("div");
            key.className = "letter-key";
            key.innerText = letter;
            key.onclick = () => toggleFilter(letter, key);
            filterBar.appendChild(key);
        });

        // INPUT LOGIC
        function handleInput(zone) {
            if (mode === "DONE") return;

            if (mode === "LENGTH") {
                wordLength++;
                buzz(15);
                resultWordEl.innerText = wordLength; 
                helperText.innerText = "Counting...";
                clearTimeout(lengthTimer);
                lengthTimer = setTimeout(() => {
                    if (wordLength > 0) {
                        mode = "FIRST";
                        buzz([50, 30, 50]); 
                        statusText.innerText = "First Letter Shape";
                        helperText.innerText = "L: Str | M: Mix | R: Curv";
                        resultWordEl.innerText = "_ " + ".".repeat(wordLength-2) + " _";
                    }
                }, 1000); 
            } 
            else if (mode === "FIRST") {
                firstShape = getShapeName(zone);
                buzz(30);
                mode = "LAST";
                statusText.innerText = "Last Letter Shape";
                resultWordEl.innerText = firstShape[0] + " " + ".".repeat(wordLength-2) + " _";
            } 
            else if (mode === "LAST") {
                lastShape = getShapeName(zone);
                buzz(100); 
                mode = "DONE";
                statusText.innerText = "Thinking...";
                helperText.innerText = "";
                resultWordEl.style.fontSize = "1.5rem";
                resultWordEl.innerText = "Fetching...";
                fetchDeepCandidates();
            }
        }

        function getShapeName(zone) {
            if (zone === 'left') return "Straight";
            if (zone === 'mid') return "Mixed"; 
            if (zone === 'right') return "Curved";
            return "Mixed";
        }

        // AI FETCH
        async function fetchDeepCandidates() {
            // We ask for 60 words to create a massive safety net
            const prompt = `
            Task: List ALL English words (up to 60) fitting these rules:
            - Length: EXACTLY ${wordLength} letters.
            - First Letter Shape: ${firstShape}.
            - Last Letter Shape: ${lastShape}.

            Shapes:
            - Straight: A, E, F, H, I, K, L, M, N, T, V, W, X, Y, Z
            - Mixed: B, D, G, J, P, Q, R, U
            - Curved: C, O, S

            Output: JSON Array of Strings. No markdown.
            Example: ["WORD1", "WORD2"]
            `;

            try {
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 12000);

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                    signal: controller.signal
                });
                
                const data = await response.json();
                let rawText = data.candidates[0].content.parts[0].text;
                rawText = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
                
                allCandidates = JSON.parse(rawText);
                allCandidates.sort(); // Sort A-Z

                // Show the filter bar now
                filterBar.style.display = "flex";
                
                // Render initial list
                renderResults(allCandidates);

            } catch (error) {
                console.error(error);
                resultWordEl.innerText = "RETRY";
            }
        }

        // FILTER LOGIC
        function toggleFilter(letter, keyElement) {
            if (allCandidates.length === 0) return;

            if (activeFilters.has(letter)) {
                activeFilters.delete(letter);
                keyElement.classList.remove("active");
            } else {
                activeFilters.add(letter);
                keyElement.classList.add("active");
            }
            
            applyFilters();
        }

        function applyFilters() {
            // Filter allCandidates based on activeFilters
            const filtered = allCandidates.filter(word => {
                // Word must contain ALL active filter letters
                for (let filterChar of activeFilters) {
                    if (!word.toUpperCase().includes(filterChar)) return false;
                }
                return true;
            });
            
            renderResults(filtered);
        }

        function renderResults(words) {
            candidatesContainer.innerHTML = "";
            
            if (words.length === 0) {
                resultWordEl.innerText = "0 MATCHES";
                return;
            }

            // Update Main Word
            resultWordEl.style.fontSize = "2.5rem";
            resultWordEl.innerText = words[0].toUpperCase();

            // Populate Grid
            words.forEach(word => {
                const btn = document.createElement("div");
                btn.className = "candidate-btn";
                btn.innerText = word.toUpperCase();
                btn.onclick = () => { resultWordEl.innerText = word.toUpperCase(); };
                candidatesContainer.appendChild(btn);
            });
        }

        function resetApp() {
            mode = "LENGTH";
            wordLength = 0;
            firstShape = "";
            lastShape = "";
            allCandidates = [];
            activeFilters.clear();
            
            // UI Resets
            resultWordEl.style.fontSize = "2.5rem";
            resultWordEl.innerText = "";
            candidatesContainer.innerHTML = "";
            filterBar.style.display = "none";
            helperText.innerText = "Tap to count letters...";
            statusText.innerText = "Ready";
            
            // Reset keys
            document.querySelectorAll('.letter-key').forEach(k => k.classList.remove('active'));
            
            buzz(20);
        }

        // Listeners
        document.getElementById('btn-left').addEventListener('click', () => handleInput('left'));
        document.getElementById('btn-mid').addEventListener('click', () => handleInput('mid'));
        document.getElementById('btn-right').addEventListener('click', () => handleInput('right'));
    </script>
</body>
</html>

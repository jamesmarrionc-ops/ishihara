<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bookends</title>
    <style>
        body {
            margin: 0;
            background-color: black;
            color: #111;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
            -webkit-user-select: none; /* Prevent selection */
            touch-action: manipulation;
        }
        #display {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 1.5rem;
            color: #222; /* Almost invisible text */
            padding: 20px;
        }
        .controls {
            height: 60vh;
            display: flex;
            width: 100%;
        }
        .zone {
            flex: 1;
            /* border: 1px solid #111; Debug borders */
        }
        .debug {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #222;
            font-size: 12px;
        }
    </style>
</head>
<body>

    <div class="debug" id="status">Mode: Length</div>
    <div id="display">Tap count...</div>

    <div class="controls" id="touch-area">
        <div class="zone" id="btn-left"></div>   <div class="zone" id="btn-mid"></div>    <div class="zone" id="btn-right"></div>  </div>

    <script>
        let apiKey = localStorage.getItem("gemini_api_key");
        if (!apiKey) {
            apiKey = prompt("Enter Gemini API Key:");
            if (apiKey) localStorage.setItem("gemini_api_key", apiKey);
        }

        // State Machine
        let mode = "LENGTH"; // LENGTH, FIRST, LAST, DONE
        let wordLength = 0;
        let firstShape = "";
        let lastShape = "";
        let lengthTimer = null;

        const display = document.getElementById("display");
        const status = document.getElementById("status");

        // Vibrator helper
        const buzz = (ms) => { if (navigator.vibrate) navigator.vibrate(ms); };

        // INPUT HANDLER
        function handleInput(zone) {
            
            if (mode === "LENGTH") {
                // Any tap counts as +1
                wordLength++;
                buzz(30); // Short buzz
                display.innerText = wordLength; 
                
                // Reset timer. If no tap for 2 seconds, lock length.
                clearTimeout(lengthTimer);
                lengthTimer = setTimeout(() => {
                    if (wordLength > 0) {
                        mode = "FIRST";
                        buzz([50, 50, 50]); // Double buzz: Length Locked
                        status.innerText = "Mode: First (L=Str, M=Mix, R=Curv)";
                        display.innerText = "_ " + ".".repeat(wordLength-2) + " _";
                    }
                }, 1500); // 1.5 seconds silence to lock length
            } 
            
            else if (mode === "FIRST") {
                if (zone === 'left') firstShape = "Straight";
                if (zone === 'mid') firstShape = "Mixed";
                if (zone === 'right') firstShape = "Curved";
                
                buzz(50);
                mode = "LAST";
                status.innerText = "Mode: Last (L=Str, M=Mix, R=Curv)";
                display.innerText = firstShape[0] + " " + ".".repeat(wordLength-2) + " _";
            } 
            
            else if (mode === "LAST") {
                if (zone === 'left') lastShape = "Straight";
                if (zone === 'mid') lastShape = "Mixed";
                if (zone === 'right') lastShape = "Curved";
                
                buzz(100); // Long buzz: Generating
                mode = "DONE";
                status.innerText = "Thinking...";
                display.innerText = "Thinking...";
                fetchPrediction();
            }
            
            else if (mode === "DONE") {
                // Tap to reset
                reset();
            }
        }

        // Zone Listeners
        document.getElementById('btn-left').addEventListener('click', () => handleInput('left'));
        document.getElementById('btn-mid').addEventListener('click', () => handleInput('mid'));
        document.getElementById('btn-right').addEventListener('click', () => handleInput('right'));
        // For length, tapping anywhere works, but let's stick to the zones to keep it simple.

        function reset() {
            mode = "LENGTH";
            wordLength = 0;
            firstShape = "";
            lastShape = "";
            display.innerText = "Tap count...";
            status.innerText = "Mode: Length";
            display.style.color = "#222";
        }

        async function fetchPrediction() {
            const prompt = `
            Task: Mentalism Word Reveal.
            Identify common English words that fit these constraints:
            1. Length: Exactly ${wordLength} letters.
            2. First Letter Shape: ${firstShape}.
            3. Last Letter Shape: ${lastShape}.

            Use these Strict Shape Definitions:
            - Straight: A, E, F, H, I, K, L, M, N, T, V, W, X, Y, Z
            - Mixed: B, D, G, J, P, Q, R, U
            - Curved: C, O, S

            Output: Return only the Top 3-5 most common words.
            Format: Uppercase, separated by newlines. No explanations.
            If user input seems like "Tiger", ensure Tiger is in the list.
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                
                display.style.color = "#AAA"; // Make text visible for magician
                display.innerText = text;
            } catch (error) {
                display.innerText = "Error/Offline";
            }
        }
    </script>
</body>
</html>

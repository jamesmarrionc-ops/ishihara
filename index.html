<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visual Signal Test</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        canvas { display: block; width: 100vw; height: 100vh; }
        
        /* ADMIN PANEL STYLES */
        #admin-panel {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 999; flex-direction: column;
        }
        .btn {
            flex: 1; border: 1px solid #333; color: #fff; font-size: 3rem; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            background: #000; text-transform: uppercase;
        }
        .btn:active { background: #0f0; color: #000; } /* Flash green on press */
        
        #status-text {
            position: absolute; bottom: 20px; width: 100%; text-align: center;
            color: #666; font-size: 12px; pointer-events: none; letter-spacing: 2px;
        }
    </style>
</head>
<body>

    <canvas id="canvas"></canvas>
    <div id="status-text">SIGNAL NOISE: 100%</div>

    <div id="admin-panel">
        <div class="btn" style="border-bottom: 2px solid #333" onclick="trigger('7')">FORCE 7</div>
        <div class="btn" style="border-bottom: 2px solid #333" onclick="trigger('5')">FORCE 5</div>
        <div class="btn" style="color: #f55" onclick="trigger('stop')">STOP</div>
    </div>

<script>
    // --- SETUP & CONNECTION ---
    const urlParams = new URLSearchParams(window.location.search);
    const isAdmin = urlParams.get('mode') === 'admin';
    const hashID = window.location.hash.replace('#', '') || 'demo';
    const idPrefix = 'phantom-v2-User-'; 

    let peer = null;
    let conn = null;

    if (isAdmin) {
        document.getElementById('admin-panel').style.display = 'flex';
        peer = new Peer(); 
        peer.on('open', () => {
            let targetCode = prompt("Enter Code (e.g. 123):", "123");
            if(targetCode) conn = peer.connect(idPrefix + targetCode);
        });
    } else {
        peer = new Peer(idPrefix + hashID);
        peer.on('open', (id) => { document.getElementById('status-text').innerText = "CALIBRATION READY"; });
        peer.on('connection', (c) => { 
            conn = c;
            conn.on('data', (data) => { if (data.action === 'shape') currentShape = data.value; });
        });
    }

    function trigger(shape) {
        if (conn) conn.send({ action: 'shape', value: shape === 'stop' ? null : shape });
        currentShape = shape === 'stop' ? null : shape;
    }

    // --- VISUAL ENGINE (HIGH CONTRAST) ---
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    let particles = [];
    let currentShape = null;

    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
        // INCREASED DENSITY: 6000 particles for better visibility
        particles = [];
        for(let i=0; i<6000; i++) {
            particles.push({
                x: Math.random() * width,
                y: Math.random() * height,
                vx: 0, vy: 0
            });
        }
    }
    window.addEventListener('resize', resize);

    // THICKER SHAPE LOGIC
    function inShape(x, y, shape) {
        let nx = x / width; // 0.0 to 1.0
        let ny = y / height; // 0.0 to 1.0
        
        // Helper for rectangles (x1, x2, y1, y2)
        const rect = (x1, x2, y1, y2) => nx > x1 && nx < x2 && ny > y1 && ny < y2;

        if(shape === '7') {
            // Top Bar (Thick)
            if (rect(0.2, 0.8, 0.15, 0.3)) return true;
            // Diagonal Stroke (Thick)
            // Logic: Is x close to the diagonal line?
            let idealX = 0.8 - ((ny - 0.3) * 0.8); // Slope math
            if (nx > idealX - 0.08 && nx < idealX + 0.08 && ny > 0.3 && ny < 0.85) return true;
        }

        if(shape === '5') {
            if (rect(0.3, 0.75, 0.15, 0.25)) return true; // Top
            if (rect(0.3, 0.45, 0.25, 0.45)) return true; // Left down
            if (rect(0.3, 0.75, 0.45, 0.55)) return true; // Middle
            if (rect(0.6, 0.75, 0.55, 0.75)) return true; // Right down
            if (rect(0.3, 0.75, 0.75, 0.85)) return true; // Bottom
        }
        return false;
    }

    function animate() {
        // Clear screen
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, width, height);

        particles.forEach(p => {
            let isInside = currentShape ? inShape(p.x, p.y, currentShape) : false;

            if (isInside) {
                // INSIDE: BRIGHT WHITE, FLOWING RIGHT
                ctx.fillStyle = '#FFFFFF'; 
                p.x += 5; // Fast flow
                p.y += (Math.random() - 0.5); // Slight jitter
            } else {
                // OUTSIDE: DARK GREY, RANDOM JITTER
                ctx.fillStyle = currentShape ? '#222' : '#555'; // Darker when shape is active to increase contrast
                p.x += (Math.random() - 0.5) * 4;
                p.y += (Math.random() - 0.5) * 4;
            }

            // Wrap edges
            if(p.x > width) p.x = 0;
            if(p.x < 0) p.x = width;

            // Draw Dot
            ctx.fillRect(p.x, p.y, 2.5, 2.5); // Bigger dots
        });

        requestAnimationFrame(animate);
    }

    resize();
    animate();

</script>
</body>
</html>

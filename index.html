<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cipher Pro v9</title>
    <style>
        :root {
            --bg-color: #050505;
            --card-color: #1a1a1a;
            --accent-color: #007AFF;
            --text-primary: #ffffff;
            --text-secondary: #888;
            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
        }

        body {
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: var(--font-stack);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- HEADER --- */
        header {
            height: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 20;
            border-bottom: 1px solid #222;
        }

        .status-badge {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1px;
            color: var(--text-secondary);
            text-transform: uppercase;
            background: #111;
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #333;
        }

        .icon-btn {
            font-size: 18px;
            color: #666;
            padding: 8px;
            cursor: pointer;
        }

        /* --- MAIN CONTENT --- */
        main {
            flex: 1;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: relative;
        }

        /* RESULT CARD */
        #result-card {
            background-color: var(--card-color);
            border-radius: 24px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px;
            flex-shrink: 0;
            transition: all 0.3s ease;
            border: 1px solid #333;
        }

        #result-word {
            font-size: 3rem;
            font-weight: 800;
            text-align: center;
            color: #fff;
            margin: 10px 0;
            line-height: 1;
        }

        #helper-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* --- PHASE 1: BIG TAP BUTTON --- */
        #tap-surface {
            position: absolute;
            top: 180px; /* Below result card */
            left: 16px;
            right: 16px;
            bottom: 16px;
            background: #111;
            border: 2px dashed #333;
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 50;
            transition: opacity 0.3s, transform 0.3s;
        }
        #tap-surface.hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.9);
        }
        
        .tap-icon {
            font-size: 40px;
            color: #333;
            margin-bottom: 10px;
        }
        .tap-label {
            color: #444;
            font-weight: 600;
            letter-spacing: 1px;
        }

        /* --- PHASE 2: GRID & SHAPE CONTROLS --- */
        #grid-area {
            flex: 1;
            overflow-y: auto;
            border-radius: 16px;
            /* Hide initially, fade in later */
            opacity: 0; 
            transition: opacity 0.5s;
        }
        #grid-area.visible { opacity: 1; }

        #candidates-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            padding-bottom: 100px;
        }

        .candidate-btn {
            background: #111;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            color: #888;
            border: 1px solid #222;
        }
        .candidate-btn:active { background: #fff; color: #000; }

        /* --- SHAPE CONTROLS (Bottom) --- */
        .controls-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30vh;
            background: #000;
            border-top: 1px solid #222;
            display: flex;
            transform: translateY(110%); /* Hidden by default */
            transition: transform 0.4s cubic-bezier(0.17, 0.67, 0.23, 1); /* Slide up effect */
            z-index: 60;
        }
        .controls-container.active {
            transform: translateY(0);
        }

        .zone {
            flex: 1;
            position: relative;
            background: #0a0a0a;
            border-right: 1px solid #222;
        }
        .zone:last-child { border-right: none; }
        .zone:active { background: #222; }

        .zone::after {
            content: attr(data-label);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            font-weight: 700;
            color: #444;
        }

        /* --- FILTER BAR --- */
        #filter-bar-wrapper {
            position: fixed;
            bottom: 31vh; /* Above controls */
            left: 0; right: 0;
            height: 45px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            display: none; /* Hidden until results */
            align-items: center;
            overflow-x: auto;
            padding: 0 10px;
            z-index: 70;
            border-top: 1px solid #222;
        }

        .letter-key {
            min-width: 34px;
            height: 34px;
            border-radius: 8px;
            background: #222;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 13px;
            margin-right: 4px;
            flex-shrink: 0;
        }
        .letter-key.active { background: var(--accent-color); }

        /* Error Box */
        #error-box {
            position: fixed;
            top: 60px; left: 20px; right: 20px;
            background: #330000;
            border: 1px solid #ff4444;
            color: #ffcccc;
            padding: 15px;
            border-radius: 12px;
            font-size: 12px;
            display: none;
            z-index: 100;
        }

    </style>
</head>
<body>

    <header>
        <div class="status-badge" id="status-text">MODE: COUNT</div>
        <div class="icon-btn" onclick="resetKey()">ðŸ”‘</div>
        <div class="icon-btn" onclick="resetApp()">â†»</div>
    </header>

    <div id="error-box"></div>

    <main>
        <div id="result-card">
            <div id="result-word">0</div>
            <div id="helper-text">Tap the large button below to count</div>
        </div>

        <div id="tap-surface" onclick="handleTap()">
            <div class="tap-icon">ðŸ‘†</div>
            <div class="tap-label">TAP TO COUNT</div>
        </div>

        <div id="grid-area">
            <div id="candidates-container"></div>
        </div>
    </main>

    <div id="filter-bar-wrapper" id="filter-bar">
        </div>

    <div class="controls-container" id="controls">
        <div class="zone" id="btn-left" data-label="STRAIGHT" onclick="handleShape('left')"></div>
        <div class="zone" id="btn-mid" data-label="MIXED" onclick="handleShape('mid')"></div>
        <div class="zone" id="btn-right" data-label="CURVED" onclick="handleShape('right')"></div>
    </div>

    <script>
        // --- API KEY LOGIC ---
        const MODEL_NAME = "gemini-1.5-flash"; 
        let apiKey = localStorage.getItem("gemini_api_key");
        
        function checkKey() {
            if (!apiKey || apiKey.length < 10) {
                apiKey = prompt("Paste your Google Gemini API Key:");
                if (apiKey) {
                    localStorage.setItem("gemini_api_key", apiKey);
                    window.location.reload();
                }
            }
        }
        checkKey();

        function resetKey() {
            localStorage.removeItem("gemini_api_key");
            window.location.reload();
        }

        // --- STATE ---
        let mode = "COUNT"; // COUNT, SHAPE_1, SHAPE_2, DONE
        let wordLength = 0;
        let countTimer = null;
        let firstShape = "";
        let lastShape = "";
        let allCandidates = [];
        let activeFilters = new Set();

        // --- DOM ---
        const resultWordEl = document.getElementById("result-word");
        const helperText = document.getElementById("helper-text");
        const statusText = document.getElementById("status-text");
        const tapSurface = document.getElementById("tap-surface");
        const controls = document.getElementById("controls");
        const gridArea = document.getElementById("grid-area");
        const filterWrapper = document.getElementById("filter-bar-wrapper");
        const errorBox = document.getElementById("error-box");
        const candidatesContainer = document.getElementById("candidates-container");

        // --- HAPTICS ---
        const buzz = (ms) => { if (navigator.vibrate) navigator.vibrate(ms); };

        // --- PHASE 1: COUNTING ---
        function handleTap() {
            if (mode !== "COUNT") return;

            wordLength++;
            buzz(15);
            resultWordEl.innerText = wordLength;
            
            // Reset "Auto-Lock" timer
            clearTimeout(countTimer);
            countTimer = setTimeout(lockLength, 1200); // 1.2 seconds of silence locks it
        }

        function lockLength() {
            if (wordLength < 2) {
                wordLength = 0;
                resultWordEl.innerText = "0";
                return; // Ignore accidental single taps
            }

            // Transition to Phase 2
            mode = "SHAPE_1";
            buzz([50, 50, 50]); // Success buzz
            
            // UI Transition
            tapSurface.classList.add("hidden");
            controls.classList.add("active"); // Slide up controls
            
            statusText.innerText = "MODE: 1ST LETTER";
            resultWordEl.innerText = "_ " + "Â· ".repeat(wordLength-2) + " _";
            helperText.innerText = "Input First Letter Shape";
        }

        // --- PHASE 2: SHAPES ---
        function handleShape(zone) {
            if (mode === "DONE" || mode === "COUNT") return;

            let shapeName = "Mixed";
            if (zone === "left") shapeName = "Straight";
            if (zone === "right") shapeName = "Curved";

            if (mode === "SHAPE_1") {
                firstShape = shapeName;
                buzz(25);
                mode = "SHAPE_2";
                statusText.innerText = "MODE: LAST LETTER";
                resultWordEl.innerText = firstShape[0] + " " + "Â· ".repeat(wordLength-2) + " _";
                helperText.innerText = "Input Last Letter Shape";
            }
            else if (mode === "SHAPE_2") {
                lastShape = shapeName;
                buzz(80);
                mode = "DONE";
                
                // Hide controls to make room for results
                controls.classList.remove("active");
                
                statusText.innerText = "SEARCHING";
                helperText.innerText = "Deep scanning dictionary...";
                resultWordEl.style.fontSize = "2rem";
                resultWordEl.innerText = "Connecting...";
                
                fetchCandidates();
            }
        }

        // --- API & RESULTS ---
        async function fetchCandidates() {
            errorBox.style.display = "none";
            
            const prompt = `
            Return a JSON Array of up to 50 English words.
            Constraints:
            - Length: ${wordLength}
            - First Letter Shape: ${firstShape}
            - Last Letter Shape: ${lastShape}
            
            Shape Definitions:
            - Straight: A, E, F, H, I, K, L, M, N, T, V, W, X, Y, Z
            - Mixed: B, D, G, J, P, Q, R, U
            - Curved: C, O, S

            Strict Output: JSON Array of strings only.
            Example: ["WORD1", "WORD2"]
            `;

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 12000);

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`Server Error: ${response.status}`);
                }

                const data = await response.json();
                
                // Parse Logic
                let rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!rawText) throw new Error("AI returned empty response");

                rawText = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
                
                try {
                    allCandidates = JSON.parse(rawText);
                } catch (e) {
                    // Fallback for messy AI output
                    allCandidates = rawText.match(/[a-zA-Z]+/g).filter(w => w.length === wordLength);
                }

                allCandidates = allCandidates.map(w => w.toUpperCase()).sort();
                
                // Show Grid
                gridArea.classList.add("visible");
                setupFilterBar();
                renderResults(allCandidates);
                statusText.innerText = "RESULTS";
                helperText.innerText = "Tap letters below to filter";

            } catch (error) {
                console.error(error);
                resultWordEl.innerText = "ERROR";
                errorBox.style.display = "block";
                errorBox.innerText = `Details: ${error.message}. Check API Key.`;
                controls.classList.add("active"); // Bring controls back so they don't get stuck
            }
        }

        // --- FILTERING ---
        function setupFilterBar() {
            filterWrapper.style.display = "flex";
            filterWrapper.innerHTML = "";
            const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
            
            alphabet.forEach(letter => {
                const key = document.createElement("div");
                key.className = "letter-key";
                key.innerText = letter;
                key.onclick = () => {
                    buzz(10);
                    if (activeFilters.has(letter)) {
                        activeFilters.delete(letter);
                        key.classList.remove("active");
                    } else {
                        activeFilters.add(letter);
                        key.classList.add("active");
                    }
                    applyFilters();
                };
                filterWrapper.appendChild(key);
            });
        }

        function applyFilters() {
            const filtered = allCandidates.filter(word => {
                for (let char of activeFilters) {
                    if (!word.includes(char)) return false;
                }
                return true;
            });
            renderResults(filtered);
        }

        function renderResults(words) {
            candidatesContainer.innerHTML = "";
            
            if (words.length === 0) {
                resultWordEl.innerText = "NONE";
                return;
            }

            resultWordEl.style.fontSize = "3rem";
            resultWordEl.innerText = words[0];

            words.forEach(word => {
                const btn = document.createElement("div");
                btn.className = "candidate-btn";
                btn.innerText = word;
                btn.onclick = () => { 
                    resultWordEl.innerText = word; 
                    buzz(10);
                };
                candidatesContainer.appendChild(btn);
            });
        }

        function resetApp() {
            mode = "COUNT";
            wordLength = 0;
            allCandidates = [];
            activeFilters.clear();
            
            tapSurface.classList.remove("hidden");
            controls.classList.remove("active");
            gridArea.classList.remove("visible");
            filterWrapper.style.display = "none";
            errorBox.style.display = "none";
            
            resultWordEl.innerText = "0";
            resultWordEl.style.fontSize = "3rem";
            helperText.innerText = "Tap the large button below to count";
            statusText.innerText = "MODE: COUNT";
            
            buzz(30);
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cipher v2</title>
    <style>
        body {
            margin: 0;
            background-color: black;
            color: #111;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
            -webkit-user-select: none; 
            touch-action: manipulation;
        }
        #display {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 1.8rem;
            color: #222; 
            padding: 20px;
        }
        .controls {
            height: 60vh;
            display: flex;
            width: 100%;
        }
        .zone {
            flex: 1;
            /* border: 1px solid #111; */ /* Debug borders off */
        }
        .status-dot {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #333;
        }
        .debug {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #333;
            font-size: 12px;
        }
    </style>
</head>
<body>

    <div class="debug" id="status-text">Ready</div>
    <div class="status-dot" id="conn-dot"></div>
    
    <div id="display">Tap count...</div>

    <div class="controls">
        <div class="zone" id="btn-left"></div>   <div class="zone" id="btn-mid"></div>    <div class="zone" id="btn-right"></div>  </div>

    <script>
        // --- CONFIGURATION ---
        // UPDATED MODEL to 2.5 Flash for stability
        const MODEL_NAME = "gemini-2.5-flash"; 
        
        let apiKey = localStorage.getItem("gemini_api_key");
        if (!apiKey) {
            apiKey = prompt("Enter Gemini API Key:");
            if (apiKey) localStorage.setItem("gemini_api_key", apiKey);
        }

        // State Machine
        let mode = "LENGTH"; 
        let wordLength = 0;
        let firstShape = "";
        let lastShape = "";
        let lengthTimer = null;

        const display = document.getElementById("display");
        const statusText = document.getElementById("status-text");
        const dot = document.getElementById("conn-dot");

        const buzz = (ms) => { if (navigator.vibrate) navigator.vibrate(ms); };

        // INPUT LOGIC
        function handleInput(zone) {
            
            if (mode === "LENGTH") {
                wordLength++;
                buzz(20); 
                display.innerText = wordLength; 
                
                clearTimeout(lengthTimer);
                lengthTimer = setTimeout(() => {
                    if (wordLength > 0) {
                        mode = "FIRST";
                        buzz([40, 40]); // Double buzz = Length Locked
                        statusText.innerText = "First Letter?";
                        display.innerText = "_ " + ".".repeat(wordLength-2) + " _";
                    }
                }, 1200); 
            } 
            
            else if (mode === "FIRST") {
                if (zone === 'left') firstShape = "Straight";
                if (zone === 'mid') firstShape = "Mixed";
                if (zone === 'right') firstShape = "Curved";
                
                buzz(30);
                mode = "LAST";
                statusText.innerText = "Last Letter?";
                display.innerText = firstShape[0] + " " + ".".repeat(wordLength-2) + " _";
            } 
            
            else if (mode === "LAST") {
                if (zone === 'left') lastShape = "Straight";
                if (zone === 'mid') lastShape = "Mixed";
                if (zone === 'right') lastShape = "Curved";
                
                buzz(100); 
                mode = "DONE";
                statusText.innerText = "Thinking...";
                display.innerText = "Thinking...";
                display.style.color = "#666";
                
                fetchPrediction();
            }
            
            else if (mode === "DONE") {
                reset();
            }
        }

        // Listeners
        document.getElementById('btn-left').addEventListener('click', () => handleInput('left'));
        document.getElementById('btn-mid').addEventListener('click', () => handleInput('mid'));
        document.getElementById('btn-right').addEventListener('click', () => handleInput('right'));

        function reset() {
            mode = "LENGTH";
            wordLength = 0;
            firstShape = "";
            lastShape = "";
            display.innerText = "Tap count...";
            statusText.innerText = "Ready";
            display.style.color = "#222";
            dot.style.backgroundColor = "#333";
        }

        async function fetchPrediction() {
            const prompt = `
            Strict Task: Mentalism Word Reveal.
            
            1. Find the most common English word that fits this shape pattern:
               - Length: EXACTLY ${wordLength} letters.
               - First Letter is: ${firstShape}.
               - Last Letter is: ${lastShape}.
            
            2. ALSO: If that word has any common ANAGRAMS (same letters, different word), list them too.

            Shape Definitions:
            - Straight: A, E, F, H, I, K, L, M, N, T, V, W, X, Y, Z
            - Mixed: B, D, G, J, P, Q, R, U
            - Curved: C, O, S

            Output Format:
            WORD (Anagrams)
            WORD (Anagrams)
            
            Example Output:
            TIGER
            WATER (Wart, Raw)
            LATER (Alert, Alter)
            `;

            try {
                // UPDATED URL
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                
                if (!response.ok) throw new Error("API Error");

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                
                display.style.color = "#EEE"; 
                display.innerText = text;
                dot.style.backgroundColor = "#0F0"; // Green light = Success
            } catch (error) {
                display.innerText = "Error / Retry";
                dot.style.backgroundColor = "#F00"; // Red light = Fail
                console.error(error);
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    
    <title>Echo</title>
    <style>
        /* --- CORE STYLES --- */
        :root { --bg: #000; --text: #fff; }
        
        * { 
            box-sizing: border-box; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent;
            touch-action: none;
        }
        
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; position: fixed;
        }

        /* --- STATUS DOT (Tiny & Discreet) --- */
        #dict-dot {
            position: absolute; top: 15px; right: 15px;
            width: 4px; height: 4px; border-radius: 50%;
            background-color: #ffa500; 
            transition: background-color 0.5s;
            z-index: 50; opacity: 0.5;
        }

        /* --- INPUT LAYER --- */
        #input-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 10; display: flex; flex-direction: column; 
        }
        
        .shape-zone {
            flex: 1; display: flex; align-items: center; justify-content: center;
            font-size: 14px; letter-spacing: 2px; color: #222;
            border-bottom: 1px solid #111; opacity: 0; transition: opacity 0.3s;
        }
        .shape-zone:last-child { border-bottom: none; }

        /* --- STATUS TEXT (Debug Info) --- */
        #status {
            position: absolute; bottom: 20%; left: 0; width: 100%;
            text-align: center; color: #333; font-size: 10px; letter-spacing: 1px;
            pointer-events: none; transition: color 0.2s;
        }

        /* --- LIVE CANDIDATE LIST (The Peek) --- */
        #candidate-list {
            position: absolute; bottom: 0; left: 0; width: 100%;
            height: 15%; /* Bottom 15% */
            display: flex; align-items: center; justify-content: center;
            padding: 0 10px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: #333; /* Dark Grey: Visible to user, hidden to spectator */
            font-family: monospace;
            text-transform: uppercase;
            z-index: 60;
            pointer-events: none;
            white-space: pre-wrap; /* Allows wrapping */
        }

        /* --- FILTER LAYER --- */
        #filter-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: transparent; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 15; pointer-events: none; /* Let clicks pass through except gestures */
        }
        
        #filter-letter {
            font-size: 6rem; 
            font-weight: 300; color: #222; margin-bottom: 20px;
            text-align: center;
        }
        
        #filter-instructions {
            display: flex; width: 100%; justify-content: space-between; padding: 0 40px;
            font-size: 10px; color: #222; text-transform: uppercase; letter-spacing: 2px;
            position: absolute; top: 50%; transform: translateY(60px);
        }

        /* --- REVEAL LAYER --- */
        #reveal-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: none;
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 70; padding: 20px;
        }

        #primary-word { 
            font-size: 3rem; font-weight: 300; color: #ccc;
            text-align: center; letter-spacing: 4px; text-transform: uppercase;
        }
        
        #alt-words { 
            font-size: 0.8rem; color: #444; text-align: center; margin-top: 20px;
        }
        
        #reset-zone {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 15%;
            background: transparent; z-index: 80;
        }
    </style>
</head>
<body>

    <div id="dict-dot"></div>

    <div id="input-layer">
        <div class="shape-zone" id="top-zone" data-shape="S">STRAIGHT</div>
        <div class="shape-zone" id="mid-zone" data-shape="C">CURVED</div>
        <div class="shape-zone" id="bot-zone" data-shape="M">MIXED</div>
    </div>

    <div id="candidate-list">...</div> 

    <div id="filter-layer">
        <div id="filter-letter">?</div>
        <div id="filter-instructions">
            <span>&lt; No</span>
            <span>Yes &gt;</span>
        </div>
    </div>

    <div id="status">System Ready</div>

    <div id="reveal-layer">
        <div id="primary-word"></div>
        <div id="alt-words"></div>
        <div id="reset-zone"></div>
    </div>

<script>
    document.addEventListener('dblclick', function(event) { event.preventDefault(); }, { passive: false });

    // --- CONFIGURATION ---
    const CONFIG = {
        minLen: 3,      
        maxLen: 14,
        tapTime: 2500,
        dictUrl: 'https://raw.githubusercontent.com/dwyl/english-words/master/words_alpha.txt'
    };

    // --- CORE DICTIONARY ---
    const CORE_WORDS = `
    JANUARY FEBRUARY MARCH APRIL MAY JUNE JULY AUGUST SEPTEMBER OCTOBER NOVEMBER DECEMBER
    MONDAY TUESDAY WEDNESDAY THURSDAY FRIDAY SATURDAY SUNDAY
    SUMMER WINTER AUTUMN SPRING SEASON HOLIDAY VACATION FESTIVAL
    YELLOW ORANGE PURPLE VIOLET INDIGO SILVER GOLDEN BRONZE COPPER CHROME MAGENTA SCARLET CRIMSON MAROON TURQUOISE EMERALD AQUAMARINE LAVENDER BEIGE BLONDE
    AFGHANISTAN ALBANIA ALGERIA ANDORRA ANGOLA ANTIGUA ARGENTINA ARMENIA AUSTRALIA AUSTRIA AZERBAIJAN BAHAMAS BAHRAIN BANGLADESH BARBADOS BELARUS BELGIUM BELIZE BENIN BHUTAN BOLIVIA BOSNIA BOTSWANA BRAZIL BRUNEI BULGARIA BURKINA BURUNDI CAMBODIA CAMEROON CANADA VERDE CENTRAL CHAD CHILE CHINA COLOMBIA COMOROS CONGO COSTA CROATIA CUBA CYPRUS CZECH DENMARK DJIBOUTI DOMINICA DOMINICAN ECUADOR EGYPT SALVADOR EQUATORIAL ERITREA ESTONIA ESWATINI ETHIOPIA FIJI FINLAND FRANCE GABON GAMBIA GEORGIA GERMANY GHANA GREECE GRENADA GUATEMALA GUINEA GUYANA HAITI HONDURAS HUNGARY ICELAND INDIA INDONESIA IRAN IRAQ IRELAND ISRAEL ITALY JAMAICA JAPAN JORDAN KAZAKHSTAN KENYA KIRIBATI KOREA KUWAIT KYRGYZSTAN LATVIA LEBANON LESOTHO LIBERIA LIBYA LIECHTENSTEIN LITHUANIA LUXEMBOURG MADAGASCAR MALAWI MALAYSIA MALDIVES MALI MALTA MARSHALL MAURITANIA MAURITIUS MEXICO MICRONESIA MOLDOVA MONACO MONGOLIA MONTENEGRO MOROCCO MOZAMBIQUE MYANMAR NAMIBIA NAURU NEPAL NETHERLANDS ZEALAND NICARAGUA NIGER NIGERIA MACEDONIA NORWAY OMAN PAKISTAN PALAU PALESTINE PANAMA PAPUA PARAGUAY PERU PHILIPPINES POLAND PORTUGAL QATAR ROMANIA RUSSIA RWANDA SAINT SAMOA MARINO SAUDI SENEGAL SERBIA SEYCHELLES LEONE SINGAPORE SLOVAKIA SLOVENIA SOLOMON SOMALIA AFRICA SPAIN LANKA SUDAN SURINAME SWEDEN SWITZERLAND SYRIA TAIWAN TAJIKISTAN TANZANIA THAILAND TIMOR TOGO TONGA TRINIDAD TUNISIA TURKEY TURKMENISTAN TUVALU UGANDA UKRAINE EMIRATES KINGDOM AMERICA URUGUAY UZBEKISTAN VANUATU VATICAN VENEZUELA VIETNAM YEMEN ZAMBIA ZIMBABWE
    AARDVARK AARDWOLF ALPACA ANIMAL NATURE JUNGLE FOREST DESERT OCEAN MAMMAL REPTILE INSECT BADGER BEAVER BOBCAT BUFFALO CAMEL CHEETAH COYOTE COUGAR DONKEY DOLPHIN ELEPHANT FERRET FOX GIRAFFE GOPHER GORILLA HAMSTER HIPPOPOTAMUS HORSE HYENA JAGUAR KANGAROO LEMUR LEOPARD LION LLAMA MANATEE MEERKAT MONKEY MOOSE MOUSE NARWHAL OCELOT OTTER PANDA PANTHER PLATYPUS PORCUPINE POSSUM RABBIT RACCOON RHINOCEROS SHEEP SKUNK SLOTH SQUIRREL TIGER WALRUS WEASEL WHALE WOMBAT ZEBRA CONDOR CRANE EAGLE FALCON FLAMINGO GOOSE HAWK HERON HUMMINGBIRD OSTRICH PARROT PELICAN PENGUIN PIGEON RAVEN SEAGULL SPARROW STORK SWAN TOUCAN TURKEY VULTURE ANCHOVY BARRACUDA CATFISH CLOWNFISH GOLDFISH GUPPY JELLYFISH LOBSTER MARLIN OCTOPUS OYSTER PIRANHA SALMON SARDINE SEAHORSE SHARK SHRIMP SQUID STARFISH STINGRAY STURGEON SWORDFISH TROUT TUNA TURTLE ANTEATER ANTELOPE ARMADILLO BABOON CHAMELEON CHIMPANZEE CHIPMUNK COBRA CROCODILE DINOSAUR DRAGONFLY GAZELL GECKO HORNET IGUANA IMPALA JACKAL KOMODO LIZARD MAMMOTH MANTIS MOCKINGBIRD MONGOOSE MOSQUITO NEWT ORANGUTAN ORCA PEACOCK PYTHON RATTLESNAKE SALAMANDER SCORPION SERPENT SPIDER TERMITE TORTOISE VIPER WALLABY WARTHOG WASP WOLF WOLVERINE WOODPECKER
    PRETTY BEAUTIFUL UGLY HAPPY ANGRY QUIET LOUD SMALL LARGE GIANT TINY HEAVY LIGHT QUICK SLOW YOUNG OLD RICH POOR CLEAN DIRTY EMPTY FULL HARD SOFT EASY TOUGH SIMPLE COMPLEX BRAVE SCARED CALM WILD NICE KIND RUDE SWEET SOUR BITTER FRESH STALE HOT COLD WARM COOL DRY WET RAINY SUNNY WINDY CLOUDY STORMY BRIGHT DARK SHINY DULL SHARP BLUNT SMOOTH ROUGH STEEP FLAT ROUND SQUARE WIDE NARROW THICK THIN TALL SHORT LONG DEEP SHALLOW BROAD TIGHT LOOSE GOOD BAD GREAT AWFUL FINE SICK HEALTHY WEAK STRONG TIRED BUSY LAZY SMART STUPID CLEVER FUNNY SERIOUS BORING EXCITING LUCKY SAFE REAL FAKE TRUE FALSE WRONG RIGHT EARLY LATE READY NEW OLD USED MODERN ANCIENT FUTURE PAST PRESENT PUBLIC PRIVATE SECRET OPEN CLOSED FREE CHEAP EXPENSIVE WORTHY VALUE LOCAL GLOBAL MAJOR MINOR SOCIAL LEGAL CIVIL HUMAN MORAL FINAL FIRST LAST UPPER LOWER INNER OUTER TOTAL EQUAL BLANK PRIME GRAND ROYAL NOBLE PROUD SORRY GUILTY LOVELY CUTE FANCY PLAIN WEIRD STRANGE CRAZY SANE ALIVE DEAD AWAKE ASLEEP HUNGRY THIRSTY FAMOUS UNKNOWN NATIVE FOREIGN WHOLE SPLIT BROKEN FIXED SINGLE MARRIED SINGLE ALONE LONELY CROWDED POLITE HUMBLE GENTLE CRUEL FIERCE SCARY SPOOKY CREEPY NASTY TASTY YUMMY SPICY BLAND SALTY GREASY CRISPY JUICY RIPE ROTTEN MOLDY TOXIC FATAL VITAL VALID VOID NULL ZERO TOTAL WHOLE EMPTY
    GOOGLE AMAZON APPLE MICROSOFT SAMSUNG TOYOTA HONDA NISSAN FERRARI PORSCHE LAMBORGHINI MERCEDES BUGATTI TESLA SUZUKI YAMAHA KAWASAKI DUCATI BOEING AIRBUS ADIDAS REEBOK CONVERSE VANS GUCCI PRADA VERSACE ROLEX OMEGA CARTIER TIFFANY CANON NIKON SONY INTEL ORACLE CISCO ADOBE PEPSI SPRITE FANTA REDBULL NESCAFE STARBUCKS MCDONALDS BURGER PIZZA SUBWAY DOMINOS KFC WENDYS WALMART TARGET COSTCO IKEA NETFLIX DISNEY SPOTIFY TWITTER FACEBOOK INSTAGRAM TIKTOK LINKEDIN YOUTUBE TWITCH REDDIT
    DESCRIPTION IMAGINATION INFORMATION EDUCATION DEVELOPMENT RELATIONSHIP ORGANIZATION INTERNATIONAL ENVIRONMENTAL COMMUNICATION REPRESENTATIVE ADMINISTRATION RESPONSIBILITY
    DIRECTOR BEHAVIOR DISASTER DISORDER REGISTER RECEIVER DAUGHTER DISTANCE DISTRICT DELIVERY DECISION DOMESTIC DEADLINE DOCTRINE DATABASE DAYLIGHT
    PEOPLE FAMILY MOTHER FATHER FRIEND PERSON GROWTH HEALTH SYSTEM OFFICE RESULT CHANGE ANSWER FUTURE ACTION EFFECT PERIOD LETTER MOMENT SECOND LITTLE REASON LESSON RECORD PUBLIC MATTER CENTER COUPLE MEMBER GENERAL SPIRIT CHANCE DOCTOR ENERGY INCOME DEGREE DESIGN AMOUNT GARDEN TRAVEL WINDOW BOTTLE SCREEN FOREST STREET SOCCER TENNIS BASKET POTATO CARROT PENCIL POLICE MEMORY CAMERA JACKET GUITAR PLANET SERVER CLIENT ACCESS IMPORT EXPORT STATUS UPDATE SEARCH ONLINE REMOVE DELETE CREATE SUBMIT CANCEL SELECT OPTION FOLLOW REVIEW WRITER ARTIST PLAYER WORKER LEADER SCHOOL REPORT MARKET CREDIT CORNER FINGER GROUND HEAVEN ISLAND NUMBER POCKET SISTER WONDER CIRCLE SQUARE SHAPES PARENT DOLLAR WEIGHT HEIGHT LENGTH VOLUME OUTPUT INPUTS CODING SCRIPT ENGINE SWITCH BRIDGE CASTLE PALACE MUSEUM TEMPLE CHURCH MOSQUE PRISON GARAGE STUDIO CINEMA THEATER CIRCUS BAKERY BARBER BEAUTY SALON DENTAL CLINIC VALLEY CANYON GALAXY NEBULA COMETS METEOR CRATER ROCKET SENSOR ROBOTS DRONES LASERS PHONES TABLET LAPTOP BUTTON SOCKET CABLES WIRING CARBON OXYGEN HELIUM LIQUID PLASMAS POWER MOTORS BRAKES CLUTCH WHEELS MIRROR BUMPER WIPERS LIGHTS SEATS CARPET FABRIC COTTON VELVET LEATHER CANVAS PLASTIC RUBBER METALS BRONZE NICKEL COBALT MARBLE GRANITE QUARTZ GRAVEL CEMENT BRICKS TIMBER BOARDS PLANKS SHEETS PAPERS CARTON PARCEL PACKET BUCKET BARREL DINNER SUPPER BRUNCH BUFFET PICNIC SNACKS COFFEE SUGARED SPICES PEPPER GARLIC ONIONS CELERY LETTUCE RADISH TURNIP PASTRY DONUTS MUFFIN COOKIE BISCUIT BUTTER CHEESE YOGURT CREAMY FROZEN GELATO SORBET SUNDAE GRAPES APPLES MELONS PAPAYA MANGOE BERRIES LEMONS LIMES
    `;

    // --- APP VARIABLES ---
    let phase = 1; 
    let inputs = { len: 0, v1: 0, v2: 0, s1: '', s2: '' };
    let tapCount = 0;
    let tapTimer = null;
    let priorityDict = {};
    let backupDict = {};
    let activeCandidates = [];
    let currentFilterLetter = '';
    let askedLetters = [];
    let wakeLock = null;

    const status = document.getElementById('status');
    const dot = document.getElementById('dict-dot');
    const zones = document.querySelectorAll('.shape-zone');
    const resetZone = document.getElementById('reset-zone');
    const filterLayer = document.getElementById('filter-layer');
    const filterLetter = document.getElementById('filter-letter');
    const candidateList = document.getElementById('candidate-list');

    // --- INITIALIZATION ---
    async function init() {
        parseWords(CORE_WORDS, priorityDict);
        try {
            const res = await fetch(CONFIG.dictUrl);
            if (!res.ok) throw new Error("Net Err");
            const text = await res.text();
            parseWords(text, backupDict);
            dot.style.backgroundColor = "#fff"; 
        } catch (e) {
            dot.style.backgroundColor = "#ffa500"; 
        }
        requestWakeLock();
    }

    async function requestWakeLock() {
        try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {}
    }

    function parseWords(text, targetDict) {
        const words = text.split(/[\s,]+/);
        words.forEach(w => {
            const word = w.trim().toUpperCase();
            if (word.length < CONFIG.minLen || word.length > CONFIG.maxLen) return;

            const v = getVowels(word);
            let v1 = v[0] || 0;
            let v2 = v[1] || 0;
            const s1 = getShape(word[0]);
            const s2 = getShape(word[word.length-1]);
            const len = word.length;
            
            const key = `${len}-${v1}-${v2}-${s1}-${s2}`;
            if (!targetDict[key]) targetDict[key] = [];
            if (!targetDict[key].includes(word) && targetDict[key].length < 30) targetDict[key].push(word);
        });
    }

    // --- LIVE LOOKUP (THE PEEK) ---
    function updateLivePeek() {
        // Collect all matches based on current knowns
        let matches = [];
        
        // Scan keys to find partial matches
        // Dictionary Key Format: LEN-V1-V2-S1-S2
        
        let allKeys = Object.keys(priorityDict).concat(Object.keys(backupDict));
        // Remove duplicates
        allKeys = [...new Set(allKeys)];

        allKeys.forEach(key => {
            const parts = key.split('-');
            const kLen = parseInt(parts[0]);
            const kV1 = parseInt(parts[1]);
            const kV2 = parseInt(parts[2]);
            const kS1 = parts[3];
            const kS2 = parts[4];

            let match = true;
            if (phase >= 2 && inputs.len !== 0 && kLen !== inputs.len) match = false;
            if (phase >= 3 && inputs.v1 !== 0 && kV1 !== inputs.v1) match = false;
            if (phase >= 4 && inputs.v2 !== 0 && kV2 !== inputs.v2) match = false;
            if (phase >= 5 && inputs.s1 !== '' && kS1 !== inputs.s1) match = false;
            if (phase >= 6 && inputs.s2 !== '' && kS2 !== inputs.s2) match = false;

            if (match) {
                if (priorityDict[key]) matches.push(...priorityDict[key]);
                if (backupDict[key]) matches.push(...backupDict[key]);
            }
        });

        // Dedupe
        activeCandidates = [...new Set(matches)];
        
        // Update UI
        if (activeCandidates.length === 0) {
            candidateList.innerText = phase > 1 ? "(0 Matches)" : "...";
        } else if (activeCandidates.length > 8) {
            candidateList.innerText = activeCandidates.slice(0, 8).join(" ") + " ...";
        } else {
            candidateList.innerText = activeCandidates.join("  ");
        }
    }

    // --- INPUT ROUTER ---
    let touchStartX = 0;
    let touchStartY = 0;

    document.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        if (!wakeLock) requestWakeLock();

        if (e.target.id === 'reset-zone') {
             e.stopPropagation();
             location.reload();
             return;
        }

        // Tapping (Phases 1-3)
        if (phase <= 3 && e.target.closest('#input-layer')) {
             if (navigator.vibrate) navigator.vibrate(10);
             handleTap();
        } 
    });

    document.addEventListener('touchend', (e) => {
        let touchEndX = e.changedTouches[0].clientX;
        let touchEndY = e.changedTouches[0].clientY;
        let diffX = touchEndX - touchStartX;
        let diffY = touchEndY - touchStartY;

        // Swipe Down (Undo)
        if (diffY > 60 && Math.abs(diffX) < 40) { undoPhase(); return; }

        // Filter Swipe (Left/Right)
        if (phase === 6) {
            if (Math.abs(diffX) > 40) {
                processFilter(diffX > 0);
            }
            return;
        }

        // Shape Selection
        if ((phase === 4 || phase === 5) && Math.abs(diffX) < 20 && Math.abs(diffY) < 20) {
            if (e.target.classList.contains('shape-zone')) {
                if (navigator.vibrate) navigator.vibrate(10);
                handleShape(e.target.dataset.shape);
            }
        }
        
        // V2 Skip Swipe
        if (phase === 3 && (touchStartX - touchEndX > 80)) {
            clearTimeout(tapTimer);
            inputs.v2 = 0; phase = 4;
            if (navigator.vibrate) navigator.vibrate([30, 30]);
            status.innerText = "Shape Mode";
            showZones();
            updateLivePeek(); // Refresh list on skip
        }
    });

    // --- UNDO ---
    function undoPhase() {
        if (phase <= 1) return;
        if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
        phase--;
        clearTimeout(tapTimer);
        tapCount = 0;
        
        // Reset Logic
        if (phase === 1) inputs.len = 0;
        if (phase === 2) inputs.v1 = 0;
        if (phase === 3) inputs.v2 = 0;
        if (phase === 4) inputs.s1 = '';
        if (phase === 5) inputs.s2 = '';

        // UI Reset
        status.innerText = "Undo";
        status.style.color = "#888";
        if (phase < 4) hideZones();
        else showZones();
        
        filterLayer.style.display = 'none';
        document.getElementById('reveal-layer').style.display = 'none';
        
        updateLivePeek(); // Refresh list on undo
    }

    // --- LOGIC ---
    function handleTap() {
        clearTimeout(tapTimer);
        tapCount++;
        status.innerText = `${tapCount}`;
        status.style.color = "#fff";
        tapTimer = setTimeout(lockTap, CONFIG.tapTime);
    }

    function lockTap() {
        if (navigator.vibrate) navigator.vibrate([30, 30]);

        if (phase === 1) { inputs.len = tapCount; status.innerText = "Len Locked"; phase = 2; }
        else if (phase === 2) { inputs.v1 = tapCount; status.innerText = "V1 Locked"; phase = 3; }
        else if (phase === 3) { inputs.v2 = tapCount; status.innerText = "First Letter Shape"; phase = 4; showZones(); }
        
        tapCount = 0;
        status.style.color = "#555";
        updateLivePeek(); // Update list immediately
    }

    function handleShape(shape) {
        if (phase === 4) {
            inputs.s1 = shape;
            status.innerText = "Last Letter Shape";
            phase = 5;
            updateLivePeek();
        } else if (phase === 5) {
            inputs.s2 = shape;
            updateLivePeek();
            finalizeInput();
        }
    }

    function finalizeInput() {
        // activeCandidates is already populated by updateLivePeek
        if (activeCandidates.length <= 1) {
            revealFinal();
        } else {
            startFilterPhase();
        }
    }

    function startFilterPhase() {
        phase = 6;
        hideZones();
        filterLayer.style.display = 'flex';
        status.innerText = "";
        nextFilterQuestion();
    }

    function nextFilterQuestion() {
        let charCounts = {};
        activeCandidates.forEach(word => {
            let uniqueChars = [...new Set(word.split(''))];
            uniqueChars.forEach(c => {
                if (!askedLetters.includes(c)) charCounts[c] = (charCounts[c] || 0) + 1;
            });
        });

        let target = activeCandidates.length / 2;
        let bestChar = '';
        let minDiff = Infinity;
        for (let c in charCounts) {
            let diff = Math.abs(charCounts[c] - target);
            if (diff < minDiff) { minDiff = diff; bestChar = c; }
        }

        if (!bestChar) { revealFinal(); return; }
        currentFilterLetter = bestChar;
        askedLetters.push(bestChar);
        filterLetter.innerText = currentFilterLetter;
        if (navigator.vibrate) navigator.vibrate(50);
    }

    function processFilter(isYes) {
        if (isYes) activeCandidates = activeCandidates.filter(w => w.includes(currentFilterLetter));
        else activeCandidates = activeCandidates.filter(w => !w.includes(currentFilterLetter));

        // Update the Peek List instantly
        if (activeCandidates.length > 8) {
            candidateList.innerText = activeCandidates.slice(0, 8).join(" ") + " ...";
        } else {
            candidateList.innerText = activeCandidates.join("  ");
        }

        if (activeCandidates.length <= 1) revealFinal();
        else nextFilterQuestion();
    }

    function revealFinal() {
        filterLayer.style.display = 'none';
        hideZones();
        phase = 7; 

        const pWord = document.getElementById('primary-word');
        const aWord = document.getElementById('alt-words');

        if (activeCandidates.length > 0) {
            pWord.innerText = activeCandidates[0];
            aWord.innerText = activeCandidates.length > 1 ? activeCandidates.slice(1, 6).join(" ") : "";
        } else {
            pWord.innerText = "No Match";
            aWord.innerText = `${inputs.len}-${inputs.v1}-${inputs.v2} (${inputs.s1}/${inputs.s2})`;
        }
        document.getElementById('reveal-layer').style.display = 'flex';
    }

    function showZones() { zones.forEach(z => { z.style.opacity = 0.3; z.style.pointerEvents = "auto"; }); }
    function hideZones() { zones.forEach(z => { z.style.opacity = 0; z.style.pointerEvents = "none"; }); }

    function getShape(char) {
        const c = char.toUpperCase();
        if ("COSU".includes(c)) return "C";
        if ("BDGJPQR".includes(c)) return "M";
        return "S";
    }
    
    function getVowels(word) {
        const vowels = "AEIOU";
        let idx = [];
        [...word].forEach((c, i) => { if (vowels.includes(c)) idx.push(i + 1); });
        return idx;
    }

    init();
</script>
</body>
</html>

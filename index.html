<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cipher Pro</title>
    <style>
        body {
            margin: 0;
            background-color: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        /* --- UI ELEMENTS --- */
        #top-bar {
            height: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            font-size: 12px;
            color: #333;
        }

        #reset-btn {
            color: #444;
            font-size: 24px;
            padding: 10px;
            cursor: pointer;
        }

        #main-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        /* The Big Reveal Word */
        #result-word {
            font-size: 3.5rem;
            font-weight: 700;
            letter-spacing: 2px;
            margin-bottom: 20px;
            color: #eee;
        }

        /* Anagram Container */
        #anagram-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Anagram Buttons */
        .anagram-btn {
            background: #222;
            color: #888;
            border: 1px solid #333;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .anagram-btn:active {
            background: #fff;
            color: #000;
        }

        /* --- INVISIBLE CONTROLS --- */
        .controls {
            height: 50vh; /* Bottom half of screen */
            display: flex;
            width: 100%;
        }
        .zone {
            flex: 1;
            /* border: 1px solid #111; Debug borders */
        }

        /* Helper Text (Instructions) */
        #helper-text {
            font-size: 1.2rem;
            color: #333;
        }
    </style>
</head>
<body>

    <div id="top-bar">
        <div id="status-text">Ready</div>
        <div id="reset-btn" onclick="resetApp()">âœ•</div>
    </div>

    <div id="main-display">
        <div id="result-word"></div>
        <div id="anagram-container"></div>
        <div id="helper-text">Tap count...</div>
    </div>

    <div class="controls">
        <div class="zone" id="btn-left"></div>   <div class="zone" id="btn-mid"></div>    <div class="zone" id="btn-right"></div>  </div>

    <script>
        // --- CONFIG ---
        const MODEL_NAME = "gemini-1.5-flash"; 
        let apiKey = localStorage.getItem("gemini_api_key");
        if (!apiKey) {
            apiKey = prompt("Enter Gemini API Key:");
            if (apiKey) localStorage.setItem("gemini_api_key", apiKey);
        }

        // --- STATE ---
        let mode = "LENGTH"; 
        let wordLength = 0;
        let firstShape = "";
        let lastShape = "";
        let lengthTimer = null;

        const resultWordEl = document.getElementById("result-word");
        const anagramContainer = document.getElementById("anagram-container");
        const helperText = document.getElementById("helper-text");
        const statusText = document.getElementById("status-text");

        const buzz = (ms) => { if (navigator.vibrate) navigator.vibrate(ms); };

        // --- INPUT LOGIC ---
        function handleInput(zone) {
            if (mode === "DONE") return; // Stop input if showing result

            if (mode === "LENGTH") {
                wordLength++;
                buzz(20);
                // Visual feedback only in helper
                resultWordEl.innerText = wordLength; 
                helperText.innerText = "Counting...";
                
                clearTimeout(lengthTimer);
                lengthTimer = setTimeout(() => {
                    if (wordLength > 0) {
                        mode = "FIRST";
                        buzz([50, 50]); 
                        statusText.innerText = "First Letter?";
                        helperText.innerText = "First Shape?";
                        resultWordEl.innerText = "_ " + ".".repeat(wordLength-2) + " _";
                    }
                }, 1200); 
            } 
            else if (mode === "FIRST") {
                firstShape = getShapeName(zone);
                buzz(30);
                mode = "LAST";
                statusText.innerText = "Last Letter?";
                helperText.innerText = "Last Shape?";
                resultWordEl.innerText = firstShape[0] + " " + ".".repeat(wordLength-2) + " _";
            } 
            else if (mode === "LAST") {
                lastShape = getShapeName(zone);
                buzz(100); 
                mode = "DONE";
                statusText.innerText = "Thinking...";
                helperText.innerText = "";
                resultWordEl.style.fontSize = "1.5rem";
                resultWordEl.innerText = "scanning...";
                
                fetchPrediction();
            }
        }

        function getShapeName(zone) {
            if (zone === 'left') return "Straight";
            if (zone === 'mid') return "Mixed";
            if (zone === 'right') return "Curved";
            return "Mixed";
        }

        // --- API CALL ---
        async function fetchPrediction() {
            // STRICT JSON PROMPT
            const prompt = `
            Task: Mentalism Word Reveal.
            You are a backend JSON API. You do not speak English. You only output JSON.

            Logic:
            1. Find the most common English word that fits this pattern:
               - Length: ${wordLength} letters.
               - First Letter Shape: ${firstShape}.
               - Last Letter Shape: ${lastShape}.
            2. Find anagrams for that word (if any common ones exist).

            Definitions:
            - Straight: A, E, F, H, I, K, L, M, N, T, V, W, X, Y, Z
            - Mixed: B, D, G, J, P, Q, R, U
            - Curved: C, O, S

            Output Format (Strict JSON):
            {
                "main": "WORD",
                "anagrams": ["ANAGRAM1", "ANAGRAM2"]
            }
            
            Example:
            {"main": "TIGER", "anagrams": []}
            {"main": "TEAM", "anagrams": ["MEAT", "MATE"]}
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                let rawText = data.candidates[0].content.parts[0].text;
                
                // Clean markdown code blocks if AI adds them
                rawText = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
                
                const json = JSON.parse(rawText);
                displayResult(json);

            } catch (error) {
                console.error(error);
                resultWordEl.innerText = "Error";
                helperText.innerText = "Try Resetting";
            }
        }

        // --- DISPLAY LOGIC ---
        function displayResult(data) {
            // 1. Show Main Word
            resultWordEl.style.fontSize = "3.5rem";
            resultWordEl.innerText = data.main.toUpperCase();

            // 2. Create Buttons for Anagrams
            anagramContainer.innerHTML = ""; // Clear old
            
            if (data.anagrams && data.anagrams.length > 0) {
                data.anagrams.forEach(word => {
                    const btn = document.createElement("div");
                    btn.className = "anagram-btn";
                    btn.innerText = word.toUpperCase();
                    // Optional: Make clicking an anagram swap it to main
                    btn.onclick = () => {
                        resultWordEl.innerText = word.toUpperCase();
                    };
                    anagramContainer.appendChild(btn);
                });
            } else {
                // If no anagrams, maybe show "No Match" or leave empty
                // helperText.innerText = "No anagrams found";
            }
        }

        // --- RESET ---
        function resetApp() {
            mode = "LENGTH";
            wordLength = 0;
            firstShape = "";
            lastShape = "";
            
            resultWordEl.style.fontSize = "3.5rem";
            resultWordEl.innerText = "";
            anagramContainer.innerHTML = "";
            helperText.innerText = "Tap count...";
            statusText.innerText = "Ready";
        }

        // Listeners
        document.getElementById('btn-left').addEventListener('click', () => handleInput('left'));
        document.getElementById('btn-mid').addEventListener('click', () => handleInput('mid'));
        document.getElementById('btn-right').addEventListener('click', () => handleInput('right'));

    </script>
</body>
</html>

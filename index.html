<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Echo">
    <link rel="apple-touch-icon" href="icon.png">
    
    <title>Echo</title>
    
    <style>
        /* --- CORE STYLES --- */
        :root { --bg: #000; --text: #fff; }
        
        * { 
            box-sizing: border-box; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent;
            touch-action: none;
        }
        
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; position: fixed;
        }

        /* --- STATUS DOT --- */
        #dict-dot {
            position: absolute; top: 15px; right: 15px;
            width: 8px; height: 8px; border-radius: 50%;
            background-color: #ffa500; /* Default Orange */
            transition: background-color 0.5s, box-shadow 0.5s;
            z-index: 50; opacity: 0.8;
            box-shadow: 0 0 2px #ffa500;
        }

        /* --- INPUT LAYER --- */
        #input-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 10; display: flex; flex-direction: column; 
        }
        
        .shape-zone {
            flex: 1; display: flex; align-items: center; justify-content: center;
            font-size: 14px; letter-spacing: 2px; color: #222;
            border-bottom: 1px solid #111; opacity: 0; transition: opacity 0.3s;
        }
        .shape-zone:last-child { border-bottom: none; }

        /* --- STATUS TEXT --- */
        #status {
            position: absolute; bottom: 15%; left: 0; width: 100%;
            text-align: center; color: #333; font-size: 10px; letter-spacing: 1px;
            pointer-events: none; transition: color 0.2s;
        }

        /* --- FILTER LAYER --- */
        #filter-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); display: none;
            flex-direction: column; align-items: center; justify-content: flex-start; 
            z-index: 15; padding-top: 25vh; 
        }
        
        #filter-letter {
            font-size: 5rem; 
            font-weight: 300; color: #eee; 
            text-align: center;
            z-index: 16;
            text-shadow: 0 0 10px #000;
        }
        
        #filter-instructions {
            display: flex; width: 100%; justify-content: space-between; padding: 0 40px;
            font-size: 10px; color: #222; text-transform: uppercase; letter-spacing: 2px;
            position: absolute; top: 50%; transform: translateY(-50%);
            pointer-events: none;
        }

        /* --- CANDIDATE LIST (FADE EFFECT) --- */
        #candidate-list {
            position: absolute; bottom: 0; left: 0; width: 100%;
            height: 35%; 
            padding: 20px;
            text-align: center;
            font-size: 12px;
            line-height: 1.6;
            color: #444; 
            font-family: monospace;
            text-transform: uppercase;
            overflow: hidden; 
            display: flex; 
            align-items: flex-end; 
            justify-content: center;
            flex-wrap: wrap;
            align-content: flex-end;
            
            /* The Fade Effect */
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 40%);
            mask-image: linear-gradient(to bottom, transparent 0%, black 40%);
        }

        /* --- REVEAL LAYER --- */
        #reveal-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: none;
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; padding: 20px;
        }

        #primary-word { 
            font-size: 1.8rem; font-weight: 600; color: #fff;
            text-align: center; letter-spacing: 1px; text-transform: uppercase;
        }
        
        #alt-words { 
            font-size: 0.7rem; color: #444; text-align: center; margin-top: 20px;
            width: 80%;
        }
        
        #reset-zone {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 15%;
            background: transparent; z-index: 30;
        }
    </style>
</head>
<body>

    <div id="dict-dot"></div>

    <div id="input-layer">
        <div class="shape-zone" id="top-zone" data-shape="S">STRAIGHT</div>
        <div class="shape-zone" id="mid-zone" data-shape="C">CURVED</div>
        <div class="shape-zone" id="bot-zone" data-shape="M">MIXED</div>
    </div>

    <div id="filter-layer">
        <div id="filter-letter">?</div>
        <div id="filter-instructions">
            <span>&lt; No</span>
            <span>Yes &gt;</span>
        </div>
        <div id="candidate-list"></div> 
    </div>

    <div id="status">System Ready</div>

    <div id="reveal-layer">
        <div id="primary-word">...</div>
        <div id="alt-words"></div>
        <div id="reset-zone"></div>
    </div>

<script>
    document.addEventListener('dblclick', function(event) { event.preventDefault(); }, { passive: false });

    // --- CONFIGURATION ---
    const CONFIG = {
        minLen: 6,      
        maxLen: 14,
        tapTime: 2500,
        dictUrl: 'https://raw.githubusercontent.com/dwyl/english-words/master/words_alpha.txt'
    };

    // --- CORE DICTIONARY (Updated with Vehicles) ---
    const CORE_WORDS = `
    VAGINA PENIS ORGASM NAKED BREAST MURDER DEATH KILLER SUICIDE POISON BLOOD GHOST SPIRIT DEMON ANGEL DEVIL HEAVEN HELL MAGIC WITCH PSYCHIC TAROT ZODIAC
    JANUARY FEBRUARY AUGUST SEPTEMBER OCTOBER NOVEMBER DECEMBER
    MONDAY TUESDAY WEDNESDAY THURSDAY FRIDAY SATURDAY SUNDAY
    SUMMER WINTER AUTUMN SPRING SEASON HOLIDAY VACATION FESTIVAL WEEKEND
    YELLOW ORANGE PURPLE VIOLET INDIGO SILVER GOLDEN BRONZE COPPER CHROME MAGENTA SCARLET CRIMSON MAROON TURQUOISE EMERALD LAVENDER BLONDE
    AFGHANISTAN ALBANIA ALGERIA ANDORRA ANGOLA ANTIGUA ARGENTINA ARMENIA AUSTRALIA AUSTRIA AZERBAIJAN BAHAMAS BAHRAIN BANGLADESH BARBADOS BELARUS BELGIUM BELIZE BHUTAN BOLIVIA BOSNIA BOTSWANA BRAZIL BRUNEI BULGARIA BURKINA BURUNDI CAMBODIA CAMEROON CANADA CENTRAL CHILE CHINA COLOMBIA COMOROS CROATIA CYPRUS DENMARK DJIBOUTI DOMINICA DOMINICAN ECUADOR SALVADOR ERITREA ESTONIA ESWATINI ETHIOPIA FINLAND FRANCE GAMBIA GEORGIA GERMANY GREECE GRENADA GUATEMALA GUINEA GUYANA HONDURAS HUNGARY ICELAND INDIA INDONESIA IRELAND ISRAEL ITALY JAMAICA JORDAN KAZAKHSTAN KIRIBATI KUWAIT KYRGYZSTAN LATVIA LEBANON LESOTHO LIBERIA LIECHTENSTEIN LITHUANIA LUXEMBOURG MADAGASCAR MALAWI MALAYSIA MALDIVES MARSHALL MAURITANIA MAURITIUS MEXICO MICRONESIA MOLDOVA MONACO MONGOLIA MONTENEGRO MOROCCO MOZAMBIQUE MYANMAR NAMIBIA NETHERLANDS ZEALAND NICARAGUA NIGERIA NORWAY PAKISTAN PALESTINE PANAMA PARAGUAY PHILIPPINES POLAND PORTUGAL ROMANIA RUSSIA RWANDA SENEGAL SERBIA SEYCHELLES SINGAPORE SLOVAKIA SLOVENIA SOLOMON SOMALIA SWEDEN SWITZERLAND TAIWAN TAJIKISTAN TANZANIA THAILAND TRINIDAD TUNISIA TURKEY TURKMENISTAN UGANDA UKRAINE EMIRATES KINGDOM AMERICA URUGUAY UZBEKISTAN VANUATU VATICAN VENEZUELA VIETNAM ZAMBIA ZIMBABWE
    AARDVARK ALPACA ANIMAL NATURE JUNGLE FOREST DESERT MAMMAL REPTILE INSECT BADGER BEAVER BOBCAT BUFFALO CHEETAH COYOTE COUGAR DONKEY DOLPHIN ELEPHANT FERRET GIRAFFE GOPHER GORILLA HAMSTER HIPPOPOTAMUS JAGUAR KANGAROO LEOPARD MANATEE MEERKAT MONKEY MOUSE NARWHAL OCELOT PANDA PANTHER PLATYPUS PORCUPINE POSSUM RABBIT RACCOON RHINOCEROS SQUIRREL WALRUS WEASEL WOMBAT CONDOR FALCON FLAMINGO HUMMINGBIRD OSTRICH PARROT PELICAN PENGUIN PIGEON SEAGULL SPARROW TOUCAN TURKEY VULTURE ANCHOVY BARRACUDA CATFISH CLOWNFISH GOLDFISH JELLYFISH LOBSTER MARLIN OCTOPUS OYSTER PIRANHA SALMON SARDINE SEAHORSE SHRIMP STARFISH STINGRAY STURGEON SWORDFISH TURTLE ANTEATER ANTELOPE ARMADILLO BABOON CHAMELEON CHIMPANZEE CHIPMUNK CROCODILE DINOSAUR DRAGONFLY GAZELL HORNET IGUANA IMPALA JACKAL KOMODO LIZARD MAMMOTH MANTIS MOCKINGBIRD MONGOOSE MOSQUITO ORANGUTAN PEACOCK PYTHON RATTLESNAKE SALAMANDER SCORPION SERPENT SPIDER TERMITE TORTOISE WALLABY WARTHOG WOLVERINE WOODPECKER
    WATERFALL RIVER OCEAN LAKE STREAM POND CREEK BROOK RAINBOW THUNDER LIGHTNING STORM TORNADO HURRICANE TYPHOON VOLCANO EARTHQUAKE TSUNAMI VALLEY CANYON GLACIER MOUNTAIN HILLSIDE
    PRETTY BEAUTIFUL LITTLE QUIET SIMPLE COMPLEX SCARED STRONG HEALTHY CLEVER SERIOUS BORING EXCITING FAMOUS UNKNOWN NATIVE FOREIGN SINGLE MARRIED LONELY CROWDED POLITE HUMBLE GENTLE FIERCE SPOOKY CREEPY GREASY CRISPY ROTTEN TOXIC VITAL VALID ENTIRE PUBLIC PRIVATE SECRET CLOSED EXPENSIVE WORTHY GLOBAL SOCIAL MORAL UPPER LOWER INNER OUTER EQUAL NOBLE GUILTY LOVELY FANCY STRANGE ALIVE HUNGRY THIRSTY BROKEN UNIQUE UNUSUAL VISUAL VIRTUAL MENTAL MANUAL MUTUAL ACTUAL ANNUAL CASUAL FORMAL NORMAL STABLE STEADY SMOOTH SUDDEN HOLLOW NARROW SHALLOW YELLOW FELLOW MELLOW WILLOW SHADOW WINDOW SORROW BORROW FOLLOW TOMORROW NARROW BATTLE BOTTLE CATTLE CASTLE LITTLE SETTLE KETTLE GENTLE CIRCLE JUNGLE SIMPLE SINGLE TEMPLE COUPLE PEOPLE PURPLE TURTLE HANDLE MIDDLE NOODLE PUZZLE SADDLE CANDLE NEEDLE POODLE BEETLE BUNDLE BUBBLE CRADLE RIPPLE STAPLE TACKLE WIGGLE WOBBLE STRUGGLE 
    MOTORCYCLE MOTORBIKE SCOOTER CHOPPER MINIVAN TRUCK TRAILER TRACTOR AMBULANCE TAXICAB LIMOUSINE
    GOOGLE AMAZON APPLE MICROSOFT SAMSUNG TOYOTA NISSAN FERRARI PORSCHE LAMBORGHINI MERCEDES BUGATTI SUZUKI YAMAHA KAWASAKI DUCATI BOEING AIRBUS ADIDAS REEBOK CONVERSE GUCCI PRADA VERSACE OMEGA CARTIER TIFFANY ORACLE CISCO ADOBE SPRITE NESCAFE STARBUCKS MCDONALDS BURGER SUBWAY DOMINOS WENDYS WALMART TARGET COSTCO NETFLIX DISNEY SPOTIFY TWITTER FACEBOOK INSTAGRAM TIKTOK LINKEDIN YOUTUBE TWITCH REDDIT
    HISTORY VENTURE VICTORY LIBRARY TEXTURE WELFARE WARFARE SUPPORT SENSOR SECTOR SYSTEM ONLINE MEMORY ACTION SERVER ACCESS SEARCH SUBMIT CANCEL SELECT OPTION REVIEW WRITER ARTIST PLAYER WORKER LEADER SCHOOL REPORT MARKET CREDIT CORNER FINGER GROUND HEAVEN ISLAND NUMBER POCKET SISTER WONDER CIRCLE SQUARE SHAPES PARENT DOLLAR WEIGHT HEIGHT LENGTH VOLUME OUTPUT CODING SCRIPT ENGINE SWITCH BRIDGE CASTLE PALACE MUSEUM TEMPLE CHURCH MOSQUE PRISON GARAGE STUDIO CINEMA THEATER CIRCUS BAKERY BARBER BEAUTY SALON DENTAL CLINIC GALAXY NEBULA COMETS METEOR CRATER ROCKET ROBOTS DRONES LASERS PHONES TABLET LAPTOP BUTTON SOCKET CABLES WIRING CARBON OXYGEN HELIUM LIQUID PLASMA MOTORS BRAKES CLUTCH WHEELS MIRROR BUMPER WIPERS LIGHTS CARPET FABRIC COTTON VELVET LEATHER CANVAS PLASTIC RUBBER METALS BRONZE NICKEL COBALT MARBLE GRANITE QUARTZ GRAVEL CEMENT BRICKS TIMBER BOARDS PLANKS SHEETS PAPERS CARTON PARCEL PACKET BUCKET BARREL DINNER SUPPER BRUNCH BUFFET PICNIC SNACKS COFFEE SPICES PEPPER GARLIC ONIONS CELERY LETTUCE RADISH TURNIP PASTRY DONUTS MUFFIN COOKIE BISCUIT BUTTER CHEESE YOGURT CREAMY FROZEN GELATO SORBET SUNDAE GRAPES APPLES MELONS PAPAYA MANGOE BERRIES LEMONS
    FAMILY FRIEND MOTHER FATHER BROTHER SISTER HUSBAND COUSIN NEPHEW UNCLE AUNTIE PERSON HUMAN WOMAN CHILD ADULT ELDER DOCTOR NURSE POLICE LAWYER JUDGE TEACHER STUDENT DRIVER ARTIST WRITER SINGER DANCER PLAYER ACTOR GUARD PRIEST FARMER CHEF COOK WAITER
    KITCHEN BEDROOM TOILET GARDEN OFFICE SCHOOL STREET MARKET STORE BRIDGE TOWER HOUSE APARTMENT WINDOW CEILING CARPET PILLOW BLANKET CURTAIN FRIDGE FREEZER COOKER OVEN TOASTER KETTLE BLENDER MICROWAVE PLATES DISHES FORKS SPOONS KNIVES GLASS BOTTLE NAPKIN TOWEL SHOWER SOAP SHAMPOO BRUSH COMB RAZOR MAKEUP PERFUME MIRROR BASIN FAUCET WATER HEATER SWITCH SOCKET LIGHTS LAMPS CANDLE MATCHES CLOCK WATCH PHONE CAMERA RADIO REMOTE BATTERY CHARGER LAPTOP TABLET SCREEN MOUSE KEYBOARD PRINTER PAPER PENCIL MARKER ERASER RULER SCISSORS GLUE TAPE STAPLER FOLDER ENVELOPE STAMP LETTER PARCEL BOXES BAGS WALLET PURSE MONEY CREDIT COINS CASH CHEQUE RECEIPT TICKET PASSPORT LICENSE
    BODY HEAD HAIR FACE EYES NOSE MOUTH TEETH TONGUE LIPS EARS NECK THROAT SHOULDER CHEST BREAST STOMACH WAIST NAVEL BACK SPINE HIPS BUTTOCKS THIGH KNEE CALF ANKLE FOOT FEET TOES ARMS ELBOW WRIST HAND FINGERS THUMB PALM NAILS SKIN BONE MUSCLE BLOOD HEART BRAIN LUNGS LIVER KIDNEY STOMACH INTESTINE BLADDER NERVE VEIN ARTERY PULSE BREATH SWEAT TEARS VOICE SMILE FROWN LAUGH CRY SLEEP DREAM WAKE TIRED SICK PAIN HURT HEAL CURE HEALTH DOCTOR MEDS PILLS DRUG
    CLOTHES SHIRT PANTS SHORTS JEANS DRESS SKIRT JACKET COAT BLAZER SUIT TIE SCARF GLOVES HAT CAP BEANIE SOCKS SHOES BOOTS SANDALS HEELS SLIPPERS PYJAMAS ROBE VEST BELT WATCH RING CHAIN NECKLACE EARRING BRACELET GLASSES BAG POCKET BUTTON ZIPPER FABRIC COTTON WOOL SILK LEATHER DENIM NYLON LINEN VELVET SATIN
    TIME SECOND MINUTE HOUR DAY WEEK MONTH YEAR DECADE CENTURY PAST PRESENT FUTURE MORNING NOON AFTERNOON EVENING NIGHT MIDNIGHT DAWN DUSK SUNRISE SUNSET TODAY TOMORROW YESTERDAY SOON LATER NEVER ALWAYS OFTEN RARELY EARLY LATE FAST SLOW SPEED QUICK DELAY PAUSE STOP START BEGIN END FINISH COMPLETE CONTINUE REPEAT AGAIN ONCE TWICE THRICE
    FEELING HAPPY SAD ANGRY SCARED AFRAID BORED TIRED HUNGRY THIRSTY SICK WELL STRONG WEAK HOT COLD WARM COOL DRY WET CLEAN DIRTY SOFT HARD ROUGH SMOOTH SHARP DULL HEAVY LIGHT DARK BRIGHT LOUD QUIET SILENT NOISY SWEET SOUR BITTER SALTY SPICY TASTY FRESH STALE RICH POOR CHEAP FREE BUSY LAZY SMART STUPID CRAZY SANE KIND CRUEL GOOD BAD EVIL WRONG RIGHT TRUE FALSE REAL FAKE OPEN SHUT FULL EMPTY HIGH LOW DEEP SHALLOW WIDE NARROW THICK THIN LONG SHORT TALL SMALL BIG HUGE TINY MANY FEW SOME NONE ALL EACH EVERY OTHER SAME DIFF
    ACTION WALKING RUNNING JUMPING SITTING STANDING LYING SLEEPING EATING DRINKING TALKING SPEAKING SHOUTING WHISPERING SINGING DANCING PLAYING WORKING STUDYING READING WRITING DRAWING PAINTING COOKING CLEANING WASHING DRYING DRIVING RIDING FLYING SWIMMING DIVING CLIMBING FALLING CATCHING THROWING HITTING KICKING PUNCHING FIGHTING KILLING LOVING KISSING HUGGING TOUCHING HOLDING CARRYING LIFTING PUSHING PULLING OPENING CLOSING LOCKING UNLOCKING CUTTING BREAKING FIXING MENDING BUILDING MAKING CREATING DESTROYING BURNING FREEZING MELTING BOILING FRYING BAKING ROASTING MIXING SHAKING STIRRING POURING SPILLING FILLING EMPTYING BUYING SELLING PAYING OWING LOSING FINDING WINNING SAVING SPENDING GIVING TAKING STEALING HIDING SEEKING SEARCHING LOOKING WATCHING HEARING LISTENING SMELLING TASTING FEELING THINKING KNOWING GUESSING HOPING WISHING DREAMING BELIEVING DOUBTING ASKING ANSWERING
    ABSTRACT FREEDOM JUSTICE LIBERTY PEACE WAR CHAOS ORDER LAW RULES CRIME PUNISH REWARD PRIZE GOAL SUCCESS FAILURE EFFORT POWER ENERGY FORCE MOTION GRAVITY SPACE TIME MATTER ATOM CELL GENE LIFE BIRTH GROWTH AGING DECAY CHANGE CHANCE LUCK FATE DESTINY KARMA FAITH HOPE LOVE HATE ANGER FEAR JOY GRIEF PAIN PLEASURE MIND SOUL SPIRIT GHOST GOD DEVIL ANGEL DEMON SIN VIRTUE TRUTH LIE FACT MYTH STORY LEGEND FABLE JOKE RIDDLE PUZZLE GAME SPORT MUSIC ART POEM SONG DANCE MOVIE PLAY DRAMA COMEDY TRAGEDY NEWS DATA INFO KNOWLEDGE WISDOM ERROR FAULT PROBLEM SOLUTION IDEA PLAN THEORY METHOD SYSTEM NETWORK GROUP TEAM CROWD MOB ARMY GANG CLUB CLASS GRADE LEVEL SCORE RANK TITLE NAME WORD SIGN SYMBOL MARK LOGO BRAND IMAGE PICTURE PHOTO VIDEO AUDIO SOUND NOISE SILENCE VOICE TONE NOTE KEY LOCK DOOR GATE WALL FENCE LINE BORDER EDGE SIDE FRONT BACK TOP BOTTOM CENTER MIDDLE INSIDE OUTSIDE UP DOWN LEFT RIGHT NORTH SOUTH EAST WEST DIRECTION DISTANCE PLACE SPOT ZONE AREA REGION COUNTRY STATE CITY TOWN VILLAGE HOME HOUSE ROOM HALL FLOOR ROOF WALL DOOR WINDOW
    `;

    // --- APP VARIABLES ---
    let phase = 1; 
    let inputs = { len: 0, v1: 0, v2: 0, s1: '', s2: '' };
    let tapCount = 0;
    let tapTimer = null;
    let priorityList = [];
    let onlineWordList = []; // Raw array of all 370k words
    let activeCandidates = [];
    let currentFilterLetter = '';
    let askedLetters = [];
    let wakeLock = null; 

    const status = document.getElementById('status');
    const dot = document.getElementById('dict-dot');
    const zones = document.querySelectorAll('.shape-zone');
    const resetZone = document.getElementById('reset-zone');
    const filterLayer = document.getElementById('filter-layer');
    const filterLetter = document.getElementById('filter-letter');
    const candidateList = document.getElementById('candidate-list');

    // --- INITIALIZATION ---
    async function init() {
        // 1. Process Core Words immediately
        priorityList = CORE_WORDS.split(/[\s,\r\n]+/).map(w => w.trim().toUpperCase()).filter(w => w.length >= CONFIG.minLen);

        // 2. Fetch Online Words but DO NOT bucket them yet (Lazy Load)
        try {
            const res = await fetch(CONFIG.dictUrl);
            if (!res.ok) throw new Error("Net Err");
            const text = await res.text();
            
            // Just split them into a giant array. Memory efficient.
            onlineWordList = text.split(/[\s,\r\n]+/).filter(w => w.length >= CONFIG.minLen);
            
            dot.style.backgroundColor = "#00ff00"; 
            dot.style.boxShadow = "0 0 5px #00ff00";
        } catch (e) {
            console.log("Offline mode active");
            dot.style.backgroundColor = "#ffa500"; 
        }

        requestWakeLock();
    }

    async function requestWakeLock() {
        try {
            if ('wakeLock' in navigator) {
                wakeLock = await navigator.wakeLock.request('screen');
            }
        } catch (err) { console.log('Wake Lock Error:', err); }
    }
    
    document.addEventListener('visibilitychange', async () => {
        if (wakeLock !== null && document.visibilityState === 'visible') { requestWakeLock(); }
    });

    // --- MAIN INPUT ROUTER & SWIPES ---
    let touchStartX = 0;
    let touchStartY = 0;

    document.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        if (!wakeLock) requestWakeLock();

        if (e.target.id === 'reset-zone') {
             e.stopPropagation();
             location.reload();
             return;
        }

        if (phase <= 3 && e.target.closest('#input-layer')) {
             if (navigator.vibrate) navigator.vibrate(10);
             handleTap();
        } 
    });

    document.addEventListener('touchend', (e) => {
        let touchEndX = e.changedTouches[0].clientX;
        let touchEndY = e.changedTouches[0].clientY;
        let diffX = touchEndX - touchStartX;
        let diffY = touchEndY - touchStartY;

        if (diffY > 60 && Math.abs(diffX) < 40) {
            undoPhase();
            return; 
        }

        if (phase === 6) {
            if (Math.abs(diffX) > 40) {
                if (diffX > 0) processFilter(true);
                else processFilter(false);
            }
            return;
        }

        if ((phase === 4 || phase === 5) && Math.abs(diffX) < 20 && Math.abs(diffY) < 20) {
            if (e.target.classList.contains('shape-zone')) {
                if (navigator.vibrate) navigator.vibrate(10);
                handleShape(e.target.dataset.shape);
            }
        }
        
        if (phase === 3 && (touchStartX - touchEndX > 80)) {
            clearTimeout(tapTimer);
            inputs.v2 = 0; phase = 4;
            if (navigator.vibrate) navigator.vibrate([30, 30]);
            status.innerText = "Skipped V2. Shape Mode.";
            showZones();
        }
    });

    function undoPhase() {
        if (phase <= 1) return;
        if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
        phase--;
        clearTimeout(tapTimer);
        tapCount = 0;
        status.style.color = "#888";

        if (phase === 1) { inputs.len = 0; status.innerText = "System Reset: Enter Length"; hideZones(); filterLayer.style.display = 'none'; }
        else if (phase === 2) { inputs.v1 = 0; status.innerText = "Length Locked. Enter V1."; }
        else if (phase === 3) { inputs.v2 = 0; status.innerText = "V1 Locked. Enter V2."; hideZones(); }
        else if (phase === 4) { inputs.s1 = ''; status.innerText = "V2 Locked. Shape 1."; showZones(); filterLayer.style.display = 'none'; }
        else if (phase === 5) { inputs.s2 = ''; status.innerText = "Shape 1 Locked. Shape 2."; showZones(); filterLayer.style.display = 'none'; document.getElementById('reveal-layer').style.display = 'none'; }
    }

    function handleTap() {
        clearTimeout(tapTimer);
        tapCount++;
        status.innerText = `Count: ${tapCount}`;
        status.style.color = "#fff";
        tapTimer = setTimeout(lockTap, CONFIG.tapTime);
    }

    function lockTap() {
        if (navigator.vibrate) navigator.vibrate([30, 30]);

        if (phase === 1) {
            inputs.len = tapCount;
            status.innerText = "Length Locked";
            phase = 2;
        } else if (phase === 2) {
            inputs.v1 = tapCount;
            status.innerText = "Vowel 1 Locked";
            phase = 3;
        } else if (phase === 3) {
            inputs.v2 = tapCount;
            status.innerText = "Think of First Letter (Capital)";
            phase = 4;
            showZones();
        }
        tapCount = 0;
        status.style.color = "#555";
    }

    function handleShape(shape) {
        if (phase === 4) {
            inputs.s1 = shape;
            status.innerText = "Think of Last Letter (Capital)";
            phase = 5;
        } else if (phase === 5) {
            inputs.s2 = shape;
            prepareReveal();
        }
    }

    // --- JUST-IN-TIME (JIT) SCANNING ---
    function prepareReveal() {
        activeCandidates = [];
        const seen = new Set();

        // Helper to check if a word matches our inputs
        const isMatch = (w) => {
            w = w.toUpperCase();
            if (w.length !== inputs.len) return false;
            
            // Check Shapes (Fastest Fail)
            const s1 = getShape(w[0]);
            if (s1 !== inputs.s1) return false;
            
            const s2 = getShape(w[w.length-1]);
            if (s2 !== inputs.s2) return false;

            // Check Vowels (Slower)
            const v = getVowels(w);
            const v1 = v[0] || 0;
            const v2 = v[1] || 0;
            return (v1 === inputs.v1 && v2 === inputs.v2);
        };

        // 1. Scan Priority List
        priorityList.forEach(w => {
            if (isMatch(w) && !seen.has(w)) {
                activeCandidates.push(w);
                seen.add(w);
            }
        });

        // 2. Scan Online List (JIT - No limits)
        if (onlineWordList.length > 0) {
            onlineWordList.forEach(w => {
                // Optimization: check length property first
                if (w.length === inputs.len) { 
                    if (isMatch(w) && !seen.has(w.toUpperCase())) {
                        activeCandidates.push(w.toUpperCase());
                        seen.add(w.toUpperCase());
                    }
                }
            });
        }

        if (activeCandidates.length <= 1) {
            revealFinal();
        } else {
            startFilterPhase();
        }
    }

    function startFilterPhase() {
        phase = 6;
        hideZones();
        filterLayer.style.display = 'flex';
        status.innerText = "";
        updateCandidateList();
        nextFilterQuestion();
    }

    function nextFilterQuestion() {
        let charCounts = {};
        activeCandidates.forEach(word => {
            let uniqueChars = [...new Set(word.split(''))];
            uniqueChars.forEach(c => {
                if (!askedLetters.includes(c)) charCounts[c] = (charCounts[c] || 0) + 1;
            });
        });

        let target = activeCandidates.length / 2;
        let bestChar = '';
        let minDiff = Infinity;
        for (let c in charCounts) {
            let diff = Math.abs(charCounts[c] - target);
            if (diff < minDiff) { minDiff = diff; bestChar = c; }
        }

        if (!bestChar) { revealFinal(); return; }
        currentFilterLetter = bestChar;
        askedLetters.push(bestChar);
        filterLetter.innerText = currentFilterLetter;
        if (navigator.vibrate) navigator.vibrate(50);
    }

    function processFilter(isYes) {
        if (isYes) activeCandidates = activeCandidates.filter(w => w.includes(currentFilterLetter));
        else activeCandidates = activeCandidates.filter(w => !w.includes(currentFilterLetter));

        updateCandidateList();

        if (activeCandidates.length <= 1) revealFinal();
        else nextFilterQuestion();
    }

    function updateCandidateList() {
        candidateList.innerText = activeCandidates.join("  ");
    }

    function revealFinal() {
        filterLayer.style.display = 'none';
        hideZones();
        phase = 7; 

        const pWord = document.getElementById('primary-word');
        const aWord = document.getElementById('alt-words');

        if (activeCandidates.length > 0) {
            const finalWord = activeCandidates[0];
            pWord.innerText = finalWord;
            aWord.innerText = activeCandidates.length > 1 ? activeCandidates.slice(1).join(" ") : "";
            forceCopyToClipboard(finalWord);
        } else {
            pWord.innerText = "No Match";
            aWord.innerText = `${inputs.len}-${inputs.v1}-${inputs.v2} (${inputs.s1}/${inputs.s2})`;
        }
        document.getElementById('reveal-layer').style.display = 'flex';
    }

    function forceCopyToClipboard(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).catch(err => fallbackCopy(text));
        } else {
            fallbackCopy(text);
        }
    }

    function fallbackCopy(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed"; 
        textArea.style.left = "-9999px";
        textArea.style.top = "0";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try { document.execCommand('copy'); } catch (err) {}
        document.body.removeChild(textArea);
    }

    function showZones() { zones.forEach(z => { z.style.opacity = 0.3; z.style.pointerEvents = "auto"; }); }
    function hideZones() { zones.forEach(z => { z.style.opacity = 0; z.style.pointerEvents = "none"; }); }

    function getShape(char) {
        if (!char) return "S";
        const c = char.toUpperCase();
        if ("COSU".includes(c)) return "C";
        if ("BDGJPQR".includes(c)) return "M";
        return "S";
    }
    
    function getVowels(word) {
        const vowels = "AEIOU";
        let idx = [];
        [...word].forEach((c, i) => { if (vowels.includes(c)) idx.push(i + 1); });
        return idx;
    }

    init();
</script>
</body>
</html>
